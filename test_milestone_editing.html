<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Milestone Editing in POAM Detail View</title>
    <script src="poam-database.js"></script>
    <script src="vulnerability-analysis-engine-v3.js"></script>
    <script src="poam-detail-redesign.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f8fafc; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-section { background: white; border-radius: 8px; padding: 20px; margin: 20px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #2563eb; }
        .poam-preview { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .milestone-item { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin: 8px 0; background: #f9fafb; }
        .log-output { background: #1f2937; color: #e5e7eb; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Test Milestone Editing in POAM Detail View</h1>
        <p>Test the editable milestone functionality integrated into POAM details</p>
        
        <div class="test-section">
            <h2>üß™ Create Test POAM</h2>
            <button onclick="createTestPOAM()">Create Test POAM with Milestones</button>
            <button onclick="createEmptyPOAM()">Create Empty POAM</button>
            <button onclick="clearDatabase()">Clear Database</button>
        </div>
        
        <div class="test-section">
            <h2>üìä POAM Detail View</h2>
            <div id="poam-detail-container">
                <p style="color: #6b7280;">Create a test POAM to see the milestone editing interface</p>
            </div>
        </div>
        
        <div class="test-section">
            <h2>üìù Test Logs</h2>
            <div class="log-output" id="logOutput">
                <div>Ready for testing...</div>
            </div>
        </div>
    </div>

    <script>
        let testPOAM = null;

        async function createTestPOAM() {
            try {
                addLog('Creating test POAM with SI milestones...');
                
                // Initialize database
                if (!poamDB || !poamDB.db) await poamDB.init();
                
                // Create test POAM with SI milestones
                testPOAM = {
                    id: `TEST-${Date.now()}`,
                    title: 'Test Windows Patching Vulnerability',
                    description: 'Test vulnerability for milestone editing',
                    controlFamily: 'SI',
                    createdDate: '2026-01-20',
                    dueDate: '2026-02-19',
                    status: 'Open',
                    poc: 'Windows Systems Team',
                    milestones: generateMilestonesForControlFamily('SI', '2026-01-20', '2026-02-19')
                };
                
                // Save to database
                await poamDB.savePOAM(testPOAM);
                
                addLog(`‚úÖ Created test POAM: ${testPOAM.id}`);
                addLog(`üìÖ Generated ${testPOAM.milestones.length} milestones`);
                
                // Display POAM detail view
                displayPOAMDetail(testPOAM);
                
            } catch (error) {
                addLog(`‚ùå Error creating test POAM: ${error.message}`);
                console.error('Error:', error);
            }
        }

        async function createEmptyPOAM() {
            try {
                addLog('Creating empty POAM...');
                
                // Initialize database
                if (!poamDB || !poamDB.db) await poamDB.init();
                
                // Create empty POAM
                testPOAM = {
                    id: `EMPTY-${Date.now()}`,
                    title: 'Empty Test POAM',
                    description: 'Test POAM with no milestones',
                    controlFamily: 'CM',
                    createdDate: '2026-01-20',
                    dueDate: '2026-04-20',
                    status: 'Open',
                    poc: 'Linux Systems Team',
                    milestones: []
                };
                
                // Save to database
                await poamDB.savePOAM(testPOAM);
                
                addLog(`‚úÖ Created empty POAM: ${testPOAM.id}`);
                
                // Display POAM detail view
                displayPOAMDetail(testPOAM);
                
            } catch (error) {
                addLog(`‚ùå Error creating empty POAM: ${error.message}`);
                console.error('Error:', error);
            }
        }

        async function clearDatabase() {
            try {
                if (confirm('This will clear all POAM data. Are you sure?')) {
                    addLog('Clearing database...');
                    
                    if (poamDB && poamDB.db) {
                        // Clear all POAMs
                        const transaction = poamDB.db.transaction(['poams'], 'readwrite');
                        const store = transaction.objectStore('poams');
                        await store.clear();
                        
                        addLog('‚úÖ Database cleared');
                        document.getElementById('poam-detail-container').innerHTML = '<p style="color: #6b7280;">Database cleared. Create a new test POAM.</p>';
                    }
                }
            } catch (error) {
                addLog(`‚ùå Error clearing database: ${error.message}`);
                console.error('Error:', error);
            }
        }

        function displayPOAMDetail(poam) {
            const container = document.getElementById('poam-detail-container');
            
            // Create a simplified POAM detail view focusing on milestones
            const detailHTML = `
                <div class="poam-preview">
                    <h3>${poam.title}</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div><strong>ID:</strong> ${poam.id}</div>
                        <div><strong>Control Family:</strong> ${poam.controlFamily}</div>
                        <div><strong>Status:</strong> ${poam.status}</div>
                        <div><strong>POC:</strong> ${poam.poc}</div>
                        <div><strong>Start Date:</strong> ${poam.createdDate}</div>
                        <div><strong>Due Date:</strong> ${poam.dueDate}</div>
                    </div>
                    
                    <div style="border-top: 1px solid #e5e7eb; padding-top: 15px; margin-top: 15px;">
                        <h4 style="margin-bottom: 10px;">üìÖ Milestones (Editable)</h4>
                        <div data-section="milestones">
                            ${renderMilestonesList(poam)}
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = detailHTML;
            
            // Set current POAM for milestone functions
            if (typeof currentPOAMDetail !== 'undefined') {
                currentPOAMDetail = poam;
            }
            
            addLog(`üìã Displayed POAM detail view for ${poam.id}`);
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML += `<div>${logMessage}</div>`;
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Mock showUpdateFeedback function
        window.showUpdateFeedback = function(message, type) {
            addLog(`üì¢ ${type.toUpperCase()}: ${message}`);
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addLog('üöÄ Milestone editing test page loaded');
            addLog('üìù Create a test POAM to see the editable milestone interface');
        });
    </script>
</body>
</html>
