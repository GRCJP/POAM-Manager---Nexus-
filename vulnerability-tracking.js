// Vulnerability Tracking Functions with Pagination

let currentPOAMPage = 1;
let poamsPerPage = 50;
let allVulnerabilityPOAMs = [];

// Handle vulnerability scan upload
function handleVulnerabilityUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('Processing vulnerability scan:', file.name);
    
    // Show processing indicator
    const scanInfo = document.getElementById('last-scan-info');
    scanInfo.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-spinner fa-spin text-indigo-600 text-2xl"></i>
            <div>
                <h4 class="text-sm font-semibold text-slate-700">Processing scan...</h4>
                <p class="text-xs text-slate-500">${file.name}</p>
            </div>
        </div>
    `;
    
    // Read and process CSV file
    const reader = new FileReader();
    reader.onload = function(e) {
        const csvContent = e.target.result;
        processLocalCSV(csvContent, file.name);
    };
    reader.readAsText(file);
}

// Process CSV and generate POAMs
function processLocalCSV(csvContent, filename) {
    try {
        const lines = csvContent.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        const poams = [];
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            if (values.length < 3) continue;
            
            const poam = {
                id: `POAM-${Date.now()}-${i}`,
                vulnerability: values[headers.indexOf('title') || headers.indexOf('vulnerability') || 1]?.trim() || 'Unknown Vulnerability',
                asset: values[headers.indexOf('host') || headers.indexOf('asset') || headers.indexOf('ip') || 2]?.trim() || 'Unknown Asset',
                risk: determineRiskLevel(values[headers.indexOf('severity') || headers.indexOf('risk') || 3]?.trim()),
                status: 'open',
                dueDate: calculateDueDate(determineRiskLevel(values[headers.indexOf('severity') || 3]?.trim())),
                poc: assignPOC(values[headers.indexOf('title') || 1]?.trim()),
                createdDate: new Date().toISOString(),
                description: values[headers.indexOf('description') || 4]?.trim() || '',
                cvss: values[headers.indexOf('cvss') || 5]?.trim() || 'N/A'
            };
            
            poams.push(poam);
        }
        
        // Save POAMs
        allVulnerabilityPOAMs = [...allVulnerabilityPOAMs, ...poams];
        localStorage.setItem('vulnerabilityPOAMs', JSON.stringify(allVulnerabilityPOAMs));
        
        // Update last scan info
        updateLastScanInfo(filename, poams.length);
        
        // Refresh POAM list
        displayVulnerabilityPOAMs();
        
        // Show success message
        alert(`✅ Successfully processed ${poams.length} vulnerabilities and created POAMs!`);
        
    } catch (error) {
        console.error('CSV processing error:', error);
        alert('Error processing CSV file. Please check the format.');
        resetLastScanInfo();
    }
}

// Determine risk level from severity
function determineRiskLevel(severity) {
    if (!severity) return 'medium';
    
    const sev = severity.toLowerCase();
    if (sev.includes('critical') || sev === '5' || sev === 'very high') return 'critical';
    if (sev.includes('high') || sev === '4') return 'high';
    if (sev.includes('medium') || sev === '3' || sev === 'moderate') return 'medium';
    if (sev.includes('low') || sev === '2' || sev === '1') return 'low';
    
    return 'medium';
}

// Calculate due date based on risk level and SLA
function calculateDueDate(riskLevel) {
    const slaConfig = JSON.parse(localStorage.getItem('slaConfig') || '{"critical":15,"high":30,"medium":60,"low":90}');
    const days = slaConfig[riskLevel] || 30;
    
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + days);
    
    return dueDate.toISOString().split('T')[0];
}

// Assign POC based on vulnerability type
function assignPOC(vulnerability) {
    if (!vulnerability) return 'Security Team';
    
    const vuln = vulnerability.toLowerCase();
    if (vuln.includes('ssl') || vuln.includes('tls') || vuln.includes('certificate')) return 'Infrastructure Team';
    if (vuln.includes('patch') || vuln.includes('update') || vuln.includes('outdated')) return 'Sysadmin Team';
    if (vuln.includes('auth') || vuln.includes('password') || vuln.includes('credential')) return 'Identity Team';
    if (vuln.includes('sql') || vuln.includes('xss') || vuln.includes('injection')) return 'AppSec Team';
    
    return 'Security Team';
}

// Update last scan info
function updateLastScanInfo(filename, poamCount) {
    const scanInfo = document.getElementById('last-scan-info');
    const lastScanDate = document.getElementById('last-scan-date');
    const lastScanPoams = document.getElementById('last-scan-poams');
    
    if (lastScanDate) lastScanDate.textContent = new Date().toLocaleString();
    if (lastScanPoams) lastScanPoams.textContent = poamCount;
    
    scanInfo.innerHTML = `
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Last Scan Processed</h4>
        <div class="flex items-center justify-between text-sm">
            <div>
                <p class="text-slate-600"><strong>File:</strong> ${filename}</p>
                <p class="text-slate-600"><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                <p class="text-slate-600"><strong>POAMs Created:</strong> ${poamCount}</p>
            </div>
            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        </div>
    `;
}

// Reset last scan info
function resetLastScanInfo() {
    const scanInfo = document.getElementById('last-scan-info');
    scanInfo.innerHTML = `
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Last Scan Processed</h4>
        <div class="flex items-center justify-between text-sm">
            <div>
                <p class="text-slate-600"><strong>Date:</strong> No scans processed yet</p>
                <p class="text-slate-600"><strong>POAMs Created:</strong> 0</p>
            </div>
            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        </div>
    `;
}

// Display vulnerability POAMs with pagination
function displayVulnerabilityPOAMs() {
    const tbody = document.getElementById('vulnerability-poam-list');
    if (!tbody) return;
    
    // Load POAMs from storage
    allVulnerabilityPOAMs = JSON.parse(localStorage.getItem('vulnerabilityPOAMs') || '[]');
    
    if (allVulnerabilityPOAMs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-12 text-center text-slate-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p class="font-medium">No POAMs generated yet</p>
                    <p class="text-sm mt-1">Upload a vulnerability scan to generate POAMs</p>
                </td>
            </tr>
        `;
        updatePaginationControls(0, 0);
        return;
    }
    
    // Calculate pagination
    const startIndex = (currentPOAMPage - 1) * poamsPerPage;
    const endIndex = Math.min(startIndex + poamsPerPage, allVulnerabilityPOAMs.length);
    const pagePoams = allVulnerabilityPOAMs.slice(startIndex, endIndex);
    
    // Render POAMs
    tbody.innerHTML = pagePoams.map(poam => {
        const riskColors = {
            'critical': 'bg-red-100 text-red-700',
            'high': 'bg-orange-100 text-orange-700',
            'medium': 'bg-yellow-100 text-yellow-700',
            'low': 'bg-green-100 text-green-700'
        };
        
        const statusColors = {
            'open': 'bg-slate-100 text-slate-700',
            'in_progress': 'bg-blue-100 text-blue-700',
            'completed': 'bg-green-100 text-green-700'
        };
        
        return `
            <tr class="hover:bg-slate-50 cursor-pointer" onclick="viewPOAMDetailsModal('${poam.id}')">
                <td class="px-4 py-3 font-mono text-sm text-indigo-600 font-semibold">${poam.id}</td>
                <td class="px-4 py-3">
                    <div class="max-w-xs truncate" title="${poam.vulnerability}">
                        ${poam.vulnerability}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.asset}</td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${riskColors[poam.risk] || 'bg-slate-100 text-slate-700'}">
                        ${poam.risk.toUpperCase()}
                    </span>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${statusColors[poam.status] || 'bg-slate-100 text-slate-700'}">
                        ${poam.status.replace('_', ' ').toUpperCase()}
                    </span>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.dueDate}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.poc}</td>
            </tr>
        `;
    }).join('');
    
    // Update pagination controls
    updatePaginationControls(startIndex, endIndex);
}

// Update pagination controls
function updatePaginationControls(startIndex, endIndex) {
    const totalPoams = allVulnerabilityPOAMs.length;
    const totalPages = Math.ceil(totalPoams / poamsPerPage);
    
    // Update count display
    const countDisplay = document.getElementById('poam-count-display');
    if (countDisplay) {
        countDisplay.textContent = totalPoams > 0 
            ? `${startIndex + 1}-${endIndex} of ${totalPoams} POAMs`
            : '0-0 of 0 POAMs';
    }
    
    // Update page display
    const currentPageDisplay = document.getElementById('current-page-display');
    const totalPagesDisplay = document.getElementById('total-pages-display');
    if (currentPageDisplay) currentPageDisplay.textContent = totalPoams > 0 ? currentPOAMPage : 0;
    if (totalPagesDisplay) totalPagesDisplay.textContent = totalPages;
    
    // Update button states
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) {
        prevBtn.disabled = currentPOAMPage <= 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentPOAMPage >= totalPages;
    }
}

// Update pagination when items per page changes
function updatePOAMPagination() {
    const select = document.getElementById('poams-per-page');
    poamsPerPage = parseInt(select.value);
    currentPOAMPage = 1;
    displayVulnerabilityPOAMs();
}

// Navigate to previous page
function previousPOAMPage() {
    if (currentPOAMPage > 1) {
        currentPOAMPage--;
        displayVulnerabilityPOAMs();
    }
}

// Navigate to next page
function nextPOAMPage() {
    const totalPages = Math.ceil(allVulnerabilityPOAMs.length / poamsPerPage);
    if (currentPOAMPage < totalPages) {
        currentPOAMPage++;
        displayVulnerabilityPOAMs();
    }
}

// View POAM details in modal
function viewPOAMDetailsModal(poamId) {
    const poam = allVulnerabilityPOAMs.find(p => p.id === poamId);
    if (!poam) return;
    
    const modal = document.getElementById('poam-details-modal');
    const content = document.getElementById('poam-details-content');
    
    const riskColors = {
        'critical': 'red',
        'high': 'orange',
        'medium': 'yellow',
        'low': 'green'
    };
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="bg-slate-50 rounded-lg p-4">
                <h3 class="font-semibold text-slate-800 mb-3">POAM Information</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>POAM ID:</strong> ${poam.id}</div>
                    <div><strong>Risk Level:</strong> <span class="px-2 py-1 bg-${riskColors[poam.risk]}-100 text-${riskColors[poam.risk]}-700 rounded text-xs font-semibold">${poam.risk.toUpperCase()}</span></div>
                    <div><strong>Status:</strong> ${poam.status.replace('_', ' ').toUpperCase()}</div>
                    <div><strong>Due Date:</strong> ${poam.dueDate}</div>
                    <div><strong>Asset:</strong> ${poam.asset}</div>
                    <div><strong>POC:</strong> ${poam.poc}</div>
                    <div><strong>Created:</strong> ${new Date(poam.createdDate).toLocaleString()}</div>
                    <div><strong>CVSS Score:</strong> ${poam.cvss}</div>
                </div>
            </div>
            
            <div class="bg-slate-50 rounded-lg p-4">
                <h3 class="font-semibold text-slate-800 mb-3">Vulnerability Details</h3>
                <p class="text-sm text-slate-700 mb-2"><strong>Title:</strong> ${poam.vulnerability}</p>
                <p class="text-sm text-slate-600">${poam.description || 'No detailed description available.'}</p>
            </div>
            
            <div class="flex gap-3">
                <button onclick="updatePOAMStatus('${poam.id}', 'in_progress')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-play mr-2"></i>Mark In Progress
                </button>
                <button onclick="updatePOAMStatus('${poam.id}', 'completed')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-check mr-2"></i>Mark Completed
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Close POAM details modal
function closePOAMDetailsModal() {
    const modal = document.getElementById('poam-details-modal');
    modal.classList.add('hidden');
}

// Update POAM status
function updatePOAMStatus(poamId, newStatus) {
    const poamIndex = allVulnerabilityPOAMs.findIndex(p => p.id === poamId);
    if (poamIndex === -1) return;
    
    allVulnerabilityPOAMs[poamIndex].status = newStatus;
    localStorage.setItem('vulnerabilityPOAMs', JSON.stringify(allVulnerabilityPOAMs));
    
    displayVulnerabilityPOAMs();
    closePOAMDetailsModal();
    
    alert(`✅ POAM ${poamId} status updated to ${newStatus.replace('_', ' ').toUpperCase()}`);
}

// Export POAM report
function exportPOAMReport() {
    if (allVulnerabilityPOAMs.length === 0) {
        alert('No POAMs to export. Upload a scan first.');
        return;
    }
    
    // Create CSV content
    const headers = ['POAM ID', 'Vulnerability', 'Asset', 'Risk Level', 'Status', 'Due Date', 'POC', 'CVSS', 'Created Date'];
    const rows = allVulnerabilityPOAMs.map(poam => [
        poam.id,
        poam.vulnerability,
        poam.asset,
        poam.risk,
        poam.status,
        poam.dueDate,
        poam.poc,
        poam.cvss,
        new Date(poam.createdDate).toLocaleString()
    ]);
    
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `POAM_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    alert('✅ POAM report exported successfully!');
}

// Configure API pulls (placeholder)
function configureAPIPulls() {
    alert('API Configuration feature coming soon! This will allow you to set up automated pulls from Qualys, Tenable, and other scanner APIs.');
}

// Initialize vulnerability tracking on module load
document.addEventListener('DOMContentLoaded', function() {
    // Load existing POAMs if any
    allVulnerabilityPOAMs = JSON.parse(localStorage.getItem('vulnerabilityPOAMs') || '[]');
    
    // Display POAMs if on vulnerability module
    if (document.getElementById('vulnerability-module')) {
        displayVulnerabilityPOAMs();
    }
});
