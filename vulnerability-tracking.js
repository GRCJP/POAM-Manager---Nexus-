// Vulnerability Tracking Functions with Pagination
// Now using IndexedDB for unlimited POAM storage

console.log('‚úÖ vulnerability-tracking.js loaded successfully');

let currentPOAMPage = 1;
let poamsPerPage = 50;
let allVulnerabilityPOAMs = [];
let totalPOAMCount = 0;

// Filter state
let activeFilters = {
    search: '',
    risk: [],        // Multi-select array
    status: '',
    poc: '',
    assetRange: '',
    dueDate: ''
};

// Track open filter dropdowns
let openFilterDropdown = null;

// Handle vulnerability scan upload
function handleVulnerabilityUpload(event) {
    console.log('üöÄ handleVulnerabilityUpload called');
    const file = event.target.files[0];
    if (!file) {
        console.log('‚ùå No file selected');
        return;
    }
    
    console.log('üìÅ Processing vulnerability scan:', file.name);
    
    // Show progress bar
    const progressDiv = document.getElementById('upload-progress');
    if (progressDiv) {
        progressDiv.classList.remove('hidden');
    }
    
    updateUploadProgress(0, 'Starting upload...', 'Initializing...');
    
    // Read and process CSV file
    const reader = new FileReader();
    reader.onload = function(e) {
        updateUploadProgress(10, 'File loaded', 'Reading CSV content...');
        const csvContent = e.target.result;
        processLocalCSV(csvContent, file.name);
    };
    reader.readAsText(file);
}

// Update upload progress bar
function updateUploadProgress(percent, statusText, detailText) {
    const progressBar = document.getElementById('upload-progress-bar');
    const progressPercent = document.getElementById('upload-progress-percent');
    const progressText = document.getElementById('upload-progress-text');
    const progressDetail = document.getElementById('upload-progress-detail');
    
    if (progressBar) {
        progressBar.style.width = percent + '%';
    }
    
    if (progressPercent) {
        progressPercent.textContent = percent + '%';
    }
    
    if (progressText) {
        progressText.textContent = statusText;
    }
    
    if (progressDetail) {
        progressDetail.textContent = detailText;
    }
}

// Process CSV and generate POAMs
async function processLocalCSV(csvContent, filename) {
    try {
        console.log('üìù processLocalCSV called with file:', filename);
        
        // Check if PapaParse is available
        if (typeof Papa === 'undefined') {
            console.error('‚ùå PapaParse library not loaded!');
            alert('Error: CSV parser library failed to load. Please refresh the page and try again.');
            return;
        }
        
        console.log('‚úÖ PapaParse library is available');
        updateUploadProgress(20, 'Parsing CSV...', 'Using PapaParse for robust CSV parsing...');
        
        // Use PapaParse for proper CSV parsing
        // Skip first 3 rows (Qualys CSVs have headers on row 4)
        const parseResult = Papa.parse(csvContent, {
            header: false,
            skipEmptyLines: true
        });
        
        // Find the header row (look for row containing "Title" and "Solution")
        let headerRowIndex = -1;
        for (let i = 0; i < Math.min(10, parseResult.data.length); i++) {
            const row = parseResult.data[i];
            if (row.includes('Title') && row.includes('Solution')) {
                headerRowIndex = i;
                break;
            }
        }
        
        if (headerRowIndex === -1) {
            console.error('‚ùå Could not find header row with Title and Solution columns');
            alert('Error: Could not find valid headers in CSV. Please check the file format.');
            return;
        }
        
        console.log(`‚úÖ Found headers at row ${headerRowIndex + 1}`);
        
        // Re-parse with correct header row
        const headers = parseResult.data[headerRowIndex].map(h => String(h).trim());
        const dataRows = parseResult.data.slice(headerRowIndex + 1);
        
        // Convert to objects
        const rows = dataRows.map(row => {
            const obj = {};
            headers.forEach((header, index) => {
                obj[header.toLowerCase()] = row[index];
            });
            return obj;
        }).filter(row => row.title || row.qid); // Filter out empty rows
        
        console.log('üìä Parse result:', {
            headerRow: headerRowIndex + 1,
            rowCount: rows.length,
            columns: headers.length
        });
        
        console.log('üìã CSV Column Names:', headers);
        console.log('üìã First Row Data:', rows[0]);
        
        updateUploadProgress(30, 'Processing vulnerabilities...', `Found ${rows.length} vulnerabilities`);
        
        // Parse raw vulnerabilities from CSV
        const rawVulnerabilities = [];
        
        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            
            // Helper function to get field value with fallbacks (fixes indexOf bug)
            const getField = (primaryKey, ...fallbackKeys) => {
                if (row[primaryKey] !== undefined && row[primaryKey] !== null && row[primaryKey] !== '') {
                    return String(row[primaryKey]).trim();
                }
                for (const key of fallbackKeys) {
                    if (row[key] !== undefined && row[key] !== null && row[key] !== '') {
                        return String(row[key]).trim();
                    }
                }
                return '';
            };
            
            // Parse raw vulnerability data with Qualys column names
            const vuln = {
                title: getField('title') || 'Unknown Vulnerability',
                host: getField('asset name', 'dns', 'asset'),
                asset: getField('asset name', 'dns', 'asset'),
                ip: getField('asset ipv4', 'ip'),
                severity: getField('severity', 'kb severity'),
                risk: determineRiskLevel(getField('severity', 'kb severity')),
                description: getField('title') || getField('cve-description', 'threat'), // Column B for Qualys
                solution: getField('solution'),
                results: getField('results'),
                cvss: getField('cvssv3.1 base (nvd)', 'cvssv2 base (nvd)', 'cvss score') || 'N/A',
                cve: getField('cve'),
                port: getField('port'),
                protocol: getField('protocol'),
                qid: getField('qid'),
                firstDetected: getField('first detected'),
                lastDetected: getField('last detected'),
                publishedOn: getField('published on'),
                patchReleased: getField('patch released'),
                category: getField('category'),
                threat: getField('threat'),
                operatingSystem: getField('operating system', 'os'), // Column AD for Qualys
                assetTags: getField('asset tags'),
                status: getField('status') // Column V - Status field
            };
            
            rawVulnerabilities.push(vuln);
            
            // Update progress for each batch of 10
            if (i % 10 === 0) {
                const progress = 30 + Math.floor((i / rows.length) * 20);
                updateUploadProgress(progress, 'Parsing vulnerabilities...', `Processed ${i} of ${rows.length} findings`);
            }
        }
        
        console.log('üìã Parsed vulnerabilities from CSV:', rawVulnerabilities.length);
        console.log('üìã First vulnerability sample:', rawVulnerabilities[0]);
        
        updateUploadProgress(60, 'Analyzing vulnerabilities...', 'Grouping by remediation strategy with SLA gating...');
        
        // Use enhanced V3 analysis engine with SLA gating and POC assignment
        console.log('üöÄ Initializing VulnerabilityAnalysisEngineV3...');
        const analysisEngine = new VulnerabilityAnalysisEngineV3();
        const poams = analysisEngine.analyzeAndGroup(rawVulnerabilities);
        
        console.log(`üìä Analysis complete: ${rawVulnerabilities.length} findings ‚Üí ${poams.length} POAMs`);
        
        updateUploadProgress(70, 'Saving POAMs...', 'Storing data in IndexedDB...');
        
        // Save POAMs to IndexedDB (unlimited storage)
        try {
            // Wait for database to be available (with timeout)
            let attempts = 0;
            const maxAttempts = 10;
            
            while (typeof poamDB === 'undefined' && attempts < maxAttempts) {
                console.log(`‚è≥ Waiting for poamDB to load... attempt ${attempts + 1}/${maxAttempts}`);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            // Debug: Check if poamDB exists
            console.log('üîç Checking poamDB availability...');
            console.log('üîç typeof poamDB:', typeof poamDB);
            console.log('üîç poamDB value:', poamDB);
            
            // Ensure poamDB is initialized
            if (typeof poamDB === 'undefined') {
                console.error('‚ùå poamDB is not defined - script may not have loaded');
                console.error('‚ùå Available scripts:', document.querySelectorAll('script[src*="poam-database"]'));
                console.error('‚ùå All scripts on page:', Array.from(document.querySelectorAll('script')).map(s => s.src || s.innerHTML.substring(0, 50)));
                throw new Error('Database not available. Please refresh the page.');
            }
            
            console.log('üîç poamDB.db exists:', !!poamDB.db);
            if (!poamDB.db) {
                console.log('‚è≥ Initializing poamDB...');
                await poamDB.init();
                console.log('‚úÖ poamDB initialized successfully');
            }
            
            const saved = await poamDB.addPOAMsBatch(poams);
            console.log(`‚úÖ Saved ${saved.saved || saved} POAMs to IndexedDB`);
            
            // Update total count
            if (typeof poamDB.countPOAMs === 'function') {
                totalPOAMCount = await poamDB.countPOAMs();
            } else {
                // Fallback: get all POAMs and count
                const allPOAMs = await poamDB.getAllPOAMs();
                totalPOAMCount = allPOAMs.length;
            }
        } catch (e) {
            console.error('Failed to save POAMs to IndexedDB:', e);
            throw new Error('Failed to save POAMs to database: ' + e.message);
        }
        
        updateUploadProgress(85, 'Updating display...', 'Refreshing POAM list...');
        
        // Update last scan info
        updateLastScanInfo(filename, poams.length);
        
        // Refresh POAM list
        await displayVulnerabilityPOAMs();
        
        // Update stored count
        updateStoredPOAMCount();
        
        // Update dashboard metrics with new POAMs
        if (typeof updateSLAMetrics === 'function') {
            console.log('üìä Updating dashboard metrics after scan...');
            await updateSLAMetrics();
        }
        
        // Update vulnerability module metrics
        await updateVulnerabilityModuleMetrics();
        
        updateUploadProgress(100, 'Complete!', `Successfully created ${poams.length} POAMs`);
        
        // Hide progress bar after 2 seconds and refresh scan history
        setTimeout(() => {
            const progressDiv = document.getElementById('upload-progress');
            if (progressDiv) {
                progressDiv.classList.add('hidden');
            }
            
            // Auto-refresh scan history to show new scan and enable clear button
            updateStoredPOAMCount();
            
            // Show subtle success notification in progress bar instead of alert
            console.log(`‚úÖ Successfully processed ${poams.length} POAMs from scan`);
            
            // Refresh the POAM display to show newly created POAMs
            setTimeout(async () => {
                await displayVulnerabilityPOAMs();
            }, 100);
        }, 2000);
        
    } catch (error) {
        console.error('CSV processing error:', error);
        updateUploadProgress(0, 'Error!', error.message);
        
        setTimeout(() => {
            const progressDiv = document.getElementById('upload-progress');
            if (progressDiv) {
                progressDiv.classList.add('hidden');
            }
            // Show error in console instead of alert
            console.error('‚ùå Error processing CSV file. Please check the format.');
            resetLastScanInfo();
        }, 2000);
    }
}

// Determine risk level from severity
function determineRiskLevel(severity) {
    if (!severity) return 'medium';
    
    const sev = severity.toLowerCase();
    if (sev.includes('critical') || sev === '5' || sev === 'very high') return 'critical';
    if (sev.includes('high') || sev === '4') return 'high';
    if (sev.includes('medium') || sev === '3' || sev === 'moderate') return 'medium';
    if (sev.includes('low') || sev === '2' || sev === '1') return 'low';
    
    return 'medium';
}

// Calculate due date based on risk level and SLA
function calculateDueDate(riskLevel) {
    const slaConfig = JSON.parse(localStorage.getItem('slaConfig') || '{"critical":15,"high":30,"medium":60,"low":90}');
    const days = slaConfig[riskLevel] || 30;
    
    const dueDate = new Date();
    dueDate.setDate(dueDate.getDate() + days);
    
    return dueDate.toISOString().split('T')[0];
}

// Assign POC based on vulnerability type
function assignPOC(vulnerability) {
    if (!vulnerability) return 'Security Team';
    
    const vuln = vulnerability.toLowerCase();
    if (vuln.includes('ssl') || vuln.includes('tls') || vuln.includes('certificate')) return 'Infrastructure Team';
    if (vuln.includes('patch') || vuln.includes('update') || vuln.includes('outdated')) return 'Sysadmin Team';
    if (vuln.includes('auth') || vuln.includes('password') || vuln.includes('credential')) return 'Identity Team';
    if (vuln.includes('sql') || vuln.includes('xss') || vuln.includes('injection')) return 'AppSec Team';
    
    return 'Security Team';
}

// Update last scan info
function updateLastScanInfo(filename, poamCount) {
    const scanInfo = document.getElementById('last-scan-info');
    const lastScanDate = document.getElementById('last-scan-date');
    const lastScanPoams = document.getElementById('last-scan-poams');
    
    if (lastScanDate) lastScanDate.textContent = new Date().toLocaleString();
    if (lastScanPoams) lastScanPoams.textContent = poamCount;
    
    scanInfo.innerHTML = `
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Last Scan Processed</h4>
        <div class="flex items-center justify-between text-sm">
            <div>
                <p class="text-slate-600"><strong>File:</strong> ${filename}</p>
                <p class="text-slate-600"><strong>Date:</strong> ${new Date().toLocaleString()}</p>
                <p class="text-slate-600"><strong>POAMs Created:</strong> ${poamCount}</p>
            </div>
            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        </div>
    `;
}

// Reset last scan info
function resetLastScanInfo() {
    const scanInfo = document.getElementById('last-scan-info');
    scanInfo.innerHTML = `
        <h4 class="text-sm font-semibold text-slate-700 mb-2">Last Scan Processed</h4>
        <div class="flex items-center justify-between text-sm">
            <div>
                <p class="text-slate-600"><strong>Date:</strong> No scans processed yet</p>
                <p class="text-slate-600"><strong>POAMs Created:</strong> 0</p>
            </div>
            <i class="fas fa-check-circle text-green-500 text-2xl"></i>
        </div>
    `;
}

async function displayVulnerabilityPOAMs() {
    const tbody = document.getElementById('vulnerability-poam-list');
    if (!tbody) return;
    
    // Ensure poamDB is available
    if (typeof poamDB === 'undefined') {
        console.error('‚ùå poamDB not available');
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-slate-500">Database not available. Please refresh the page.</td></tr>';
        return;
    }
    
    if (!poamDB.db) {
        await poamDB.init();
    }
    
    // Get all POAMs from IndexedDB for filtering
    const allPoams = await poamDB.getAllPOAMs();
    console.log(`üìä Retrieved ${allPoams.length} POAMs from database`);
    
    // Map formal POAM fields to display fields for backward compatibility
    const mappedPoams = allPoams.map(poam => {
        console.log(`üîç Mapping POAM: ${poam.id}, status: ${poam.findingStatus || poam.status}, risk: ${poam.riskLevel || poam.risk}`);
        const assetCount = poam.totalAffectedAssets || poam.assets?.length || 0;
        return {
            ...poam,
            // Map formal fields to display fields
            risk: poam.riskLevel || poam.risk || 'medium',
            status: poam.findingStatus || poam.status || 'Open',
            vulnerability: poam.vulnerabilityName || poam.vulnerability || poam.title || 'Unknown',
            description: poam.findingDescription || poam.description || '',
            dueDate: poam.updatedScheduledCompletionDate || poam.dueDate || '',
            asset: assetCount > 0 ? `${assetCount} assets` : 'No assets',
            totalAffectedAssets: assetCount,
            assets: poam.assets || [],
            poc: poam.poc || 'Unassigned'
        };
    });
    
    // Apply filters
    const filteredPoams = mappedPoams.filter(poam => matchesFilters(poam));
    console.log(`üîç Filtered ${filteredPoams.length} POAMs from ${mappedPoams.length} total`);
    console.log(`üéØ Active filters:`, activeFilters);
    
    // Update total count with filtered results
    totalPOAMCount = filteredPoams.length;
    
    if (totalPOAMCount === 0) {
        const hasActiveFilters = activeFilters.search || activeFilters.risk || activeFilters.status || activeFilters.poc;
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="px-4 py-12 text-center text-slate-500">
                    <i class="fas fa-${hasActiveFilters ? 'filter' : 'inbox'} text-4xl mb-3"></i>
                    <p class="font-medium">${hasActiveFilters ? 'No POAMs match your filters' : 'No POAMs generated yet'}</p>
                    <p class="text-sm mt-1">${hasActiveFilters ? 'Try adjusting your search or filter criteria' : 'Upload a vulnerability scan to generate POAMs'}</p>
                </td>
            </tr>
        `;
        updatePaginationControls(0, 0);
        return;
    }
    
    // Calculate pagination on filtered results
    const startIndex = (currentPOAMPage - 1) * poamsPerPage;
    const endIndex = Math.min(startIndex + poamsPerPage, totalPOAMCount);
    
    // Get paginated slice of filtered POAMs
    const pagePoams = filteredPoams.slice(startIndex, endIndex);
    
    // Render POAMs
    tbody.innerHTML = pagePoams.map(poam => {
        const riskColors = {
            'critical': 'bg-red-100 text-red-700',
            'high': 'bg-orange-100 text-orange-700',
            'medium': 'bg-yellow-100 text-yellow-700',
            'low': 'bg-green-100 text-green-700'
        };
        
        const statusColors = {
            'open': 'bg-blue-100 text-blue-700',
            'in-progress': 'bg-yellow-100 text-yellow-700',
            'completed': 'bg-green-100 text-green-700',
            'closed': 'bg-slate-100 text-slate-700',
            'risk-accepted': 'bg-purple-100 text-purple-700'
        };
        
        const assetDisplay = poam.totalAffectedAssets ? `${poam.totalAffectedAssets} assets` : (poam.asset || 'N/A');
        const titleDisplay = poam.title || poam.vulnerability;
        
        // Determine icon based on POAM type
        const poamIcon = getPOAMTypeIcon(poam);
        
        return `
            <tr class="border-b border-slate-100 hover:bg-indigo-50 transition-colors cursor-pointer" onclick="showPOAMDetails('${poam.id}')">
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <input 
                        type="checkbox" 
                        class="poam-checkbox rounded border-slate-300 text-indigo-600 focus:ring-indigo-500"
                        data-poam-id="${poam.id}"
                        onchange="togglePOAMSelection('${poam.id}', this.checked)">
                </td>
                <td class="px-4 py-3 text-sm font-medium text-indigo-600">
                    <div class="flex items-center gap-2">
                        <i class="${poamIcon.icon} ${poamIcon.color}" title="${poamIcon.label}"></i>
                        ${poam.id}
                        ${poam.vulnerabilityCount ? `<span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">${poam.vulnerabilityCount} vulns</span>` : ''}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-800">
                    <div class="flex flex-col gap-1">
                        <div class="max-w-md truncate" title="${titleDisplay}">${titleDisplay}</div>
                        ${poam.tags && poam.tags.length > 0 ? `
                            <div class="flex flex-wrap gap-1">
                                ${poam.tags.map(tag => `
                                    <span class="px-2 py-0.5 bg-indigo-100 text-indigo-700 rounded text-xs">
                                        <i class="fas fa-tag text-xs"></i> ${tag}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">
                    <div class="flex items-center gap-1">
                        <i class="fas fa-server text-xs text-slate-400"></i>
                        ${assetDisplay}
                    </div>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${riskColors[poam.risk] || riskColors['medium']}">
                        ${poam.risk}
                    </span>
                </td>
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <select 
                        class="px-2 py-1 rounded text-xs font-semibold border-0 cursor-pointer ${statusColors[poam.status] || statusColors['open']}"
                        onchange="updatePOAMStatus('${poam.id}', this.value)"
                        value="${poam.status}">
                        <option value="open" ${poam.status === 'open' ? 'selected' : ''}>Open</option>
                        <option value="in-progress" ${poam.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="risk-accepted" ${poam.status === 'risk-accepted' ? 'selected' : ''}>Risk Accepted</option>
                        <option value="extended" ${poam.status === 'extended' ? 'selected' : ''}>Extended</option>
                        <option value="completed" ${poam.status === 'completed' ? 'selected' : ''}>Completed</option>
                        <option value="closed" ${poam.status === 'closed' ? 'selected' : ''}>Closed</option>
                    </select>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.dueDate}</td>
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <select 
                        class="px-2 py-1 rounded text-xs border border-slate-200 cursor-pointer bg-white"
                        onchange="updatePOAMPOC('${poam.id}', this.value)"
                        value="${poam.poc || poam.pocTeam || 'Unassigned'}">
                        <option value="Unassigned" ${(!poam.poc && !poam.pocTeam) || poam.poc === 'Unassigned' ? 'selected' : ''}>Unassigned</option>
                        <option value="Windows Systems Team" ${(poam.poc === 'Windows Systems Team' || poam.pocTeam === 'Windows Systems Team') ? 'selected' : ''}>Windows Systems Team</option>
                        <option value="Linux Systems Team" ${(poam.poc === 'Linux Systems Team' || poam.pocTeam === 'Linux Systems Team') ? 'selected' : ''}>Linux Systems Team</option>
                        <option value="Network Engineering Team" ${(poam.poc === 'Network Engineering Team' || poam.pocTeam === 'Network Engineering Team') ? 'selected' : ''}>Network Engineering Team</option>
                        <option value="Desktop Engineering Team" ${(poam.poc === 'Desktop Engineering Team' || poam.pocTeam === 'Desktop Engineering Team') ? 'selected' : ''}>Desktop Engineering Team</option>
                        <option value="Application Development Team" ${(poam.poc === 'Application Development Team' || poam.pocTeam === 'Application Development Team') ? 'selected' : ''}>Application Development Team</option>
                        <option value="Web Infrastructure Team" ${(poam.poc === 'Web Infrastructure Team' || poam.pocTeam === 'Web Infrastructure Team') ? 'selected' : ''}>Web Infrastructure Team</option>
                        <option value="Network Security Team" ${(poam.poc === 'Network Security Team' || poam.pocTeam === 'Network Security Team') ? 'selected' : ''}>Network Security Team</option>
                        <option value="End User Computing Team" ${(poam.poc === 'End User Computing Team' || poam.pocTeam === 'End User Computing Team') ? 'selected' : ''}>End User Computing Team</option>
                        <option value="Security Operations Team" ${(poam.poc === 'Security Operations Team' || poam.pocTeam === 'Security Operations Team') ? 'selected' : ''}>Security Operations Team</option>
                        <option value="PCI Compliance Team" ${(poam.poc === 'PCI Compliance Team' || poam.pocTeam === 'PCI Compliance Team') ? 'selected' : ''}>PCI Compliance Team</option>
                        <option value="Critical Systems Team" ${(poam.poc === 'Critical Systems Team' || poam.pocTeam === 'Critical Systems Team') ? 'selected' : ''}>Critical Systems Team</option>
                    </select>
                </td>
            </tr>
        `;
    }).join('');
    
    // Update pagination controls
    updatePaginationControls(startIndex, endIndex);
    
    // Update dashboard metrics with vulnerability POAMs
    if (typeof updateSLAMetrics === 'function') {
        updateSLAMetrics();
    }
}

// Update pagination controls
function updatePaginationControls(startIndex, endIndex) {
    const totalPoams = totalPOAMCount;
    const totalPages = Math.ceil(totalPoams / poamsPerPage);
    
    // Update count display
    const countDisplay = document.getElementById('poam-count-display');
    if (countDisplay) {
        countDisplay.textContent = totalPoams > 0 
            ? `${startIndex + 1}-${endIndex} of ${totalPoams} POAMs`
            : '0-0 of 0 POAMs';
    }
    
    // Update page display
    const currentPageDisplay = document.getElementById('current-page-display');
    const totalPagesDisplay = document.getElementById('total-pages-display');
    if (currentPageDisplay) currentPageDisplay.textContent = totalPoams > 0 ? currentPOAMPage : 0;
    if (totalPagesDisplay) totalPagesDisplay.textContent = totalPages;
    
    // Update button states
    const prevBtn = document.getElementById('prev-page-btn');
    const nextBtn = document.getElementById('next-page-btn');
    
    if (prevBtn) {
        prevBtn.disabled = currentPOAMPage <= 1;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentPOAMPage >= totalPages;
    }
}

// Update pagination when items per page changes
function updatePOAMPagination() {
    const select = document.getElementById('poams-per-page');
    poamsPerPage = parseInt(select.value);
    currentPOAMPage = 1;
    displayVulnerabilityPOAMs();
}

// Navigate to previous page
function previousPOAMPage() {
    if (currentPOAMPage > 1) {
        currentPOAMPage--;
        displayVulnerabilityPOAMs();
    }
}

// Navigate to next page
function nextPOAMPage() {
    const totalPages = Math.ceil(totalPOAMCount / poamsPerPage);
    if (currentPOAMPage < totalPages) {
        currentPOAMPage++;
        displayVulnerabilityPOAMs();
    }
}

// Update POAM status inline
async function updatePOAMStatus(poamId, newStatus) {
    try {
        // Ensure poamDB is available
        if (typeof poamDB === 'undefined' || !poamDB.db) {
            console.error('‚ùå poamDB not available');
            showUpdateFeedback('Database not available', 'error');
            return;
        }
        
        // Get the POAM from IndexedDB
        const poam = await poamDB.getPOAM(poamId);
        if (!poam) {
            console.error('POAM not found:', poamId);
            return;
        }
        
        // Update status (map to formal field)
        poam.findingStatus = newStatus;
        poam.status = newStatus; // Keep for backward compatibility
        poam.lastModifiedDate = new Date().toISOString();
        
        // Save back to IndexedDB
        await poamDB.savePOAM(poam);
        
        // Show success feedback
        showUpdateFeedback('Status updated successfully', 'success');
        
        // Refresh the display to show updated status
        await displayVulnerabilityPOAMs();
        
        console.log(`‚úÖ Updated POAM ${poamId} status to: ${newStatus}`);
    } catch (error) {
        console.error('Failed to update POAM status:', error);
        showUpdateFeedback('Failed to update status', 'error');
    }
}

// Update POAM POC inline
async function updatePOAMPOC(poamId, newPOC) {
    try {
        // Ensure poamDB is available
        if (typeof poamDB === 'undefined' || !poamDB.db) {
            console.error('‚ùå poamDB not available');
            showUpdateFeedback('Database not available', 'error');
            return;
        }
        
        // Get the POAM from IndexedDB
        const poam = await poamDB.getPOAM(poamId);
        if (!poam) {
            console.error('POAM not found:', poamId);
            return;
        }
        
        // Update POC fields
        poam.pointOfContact = newPOC;
        poam.lastModifiedDate = new Date().toISOString();
        
        // Save back to IndexedDB
        await poamDB.savePOAM(poam);
        
        // Show success feedback
        showUpdateFeedback('POC updated successfully', 'success');
        
        console.log(`‚úÖ Updated POAM ${poamId} POC to: ${newPOC}`);
    } catch (error) {
        console.error('Failed to update POAM POC:', error);
        showUpdateFeedback('Failed to update POC', 'error');
    }
}

// Show visual feedback for updates
function showUpdateFeedback(message, type = 'success') {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-4 py-3 rounded-lg shadow-lg z-50 transition-opacity duration-300 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    toast.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Apply filters and search to POAM list
async function applyPOAMFilters() {
    // Get filter values
    const searchInput = document.getElementById('poam-search-input');
    const riskFilter = document.getElementById('filter-risk');
    const statusFilter = document.getElementById('filter-status');
    const pocFilter = document.getElementById('filter-poc');
    
    activeFilters = {
        search: searchInput ? searchInput.value.toLowerCase() : '',
        risk: riskFilter ? riskFilter.value : '',
        status: statusFilter ? statusFilter.value : '',
        poc: pocFilter ? pocFilter.value : ''
    };
    
    // Reset to page 1 when filters change
    currentPOAMPage = 1;
    
    // Reload POAMs with filters
    await displayVulnerabilityPOAMs();
}

// Clear all filters
function clearPOAMFilters() {
    // Reset filter inputs
    const searchInput = document.getElementById('poam-search-input');
    const riskFilter = document.getElementById('filter-risk');
    const statusFilter = document.getElementById('filter-status');
    const pocFilter = document.getElementById('filter-poc');
    
    if (searchInput) searchInput.value = '';
    if (riskFilter) riskFilter.value = '';
    if (statusFilter) statusFilter.value = '';
    if (pocFilter) pocFilter.value = '';
    
    // Reset filter state
    activeFilters = {
        search: '',
        risk: '',
        status: '',
        poc: ''
    };
    
    // Reset to page 1
    currentPOAMPage = 1;
    
    // Reload POAMs
    displayVulnerabilityPOAMs();
}

// Get POAM type icon based on remediation type and title
function getPOAMTypeIcon(poam) {
    const title = (poam.title || poam.vulnerability || '').toLowerCase();
    const remediationType = poam.remediationType || '';
    
    // Permission/Access Control findings
    if (title.includes('password') || 
        title.includes('permission') || 
        title.includes('access control') ||
        title.includes('authentication') ||
        title.includes('authorization') ||
        title.includes('privilege') ||
        title.includes('account') ||
        title.includes('user') ||
        title.includes('credential')) {
        return {
            icon: 'fas fa-user-shield',
            color: 'text-purple-600',
            label: 'Permission/Access Control'
        };
    }
    
    // Configuration findings
    if (remediationType === 'config_change' ||
        remediationType === 'operational_mitigation' ||
        title.includes('configuration') ||
        title.includes('misconfiguration') ||
        title.includes('hardening') ||
        title.includes('ssl') ||
        title.includes('tls') ||
        title.includes('cipher') ||
        title.includes('protocol') ||
        title.includes('service') ||
        title.includes('enabled') ||
        title.includes('disabled') ||
        title.includes('netbios') ||
        title.includes('dns')) {
        return {
            icon: 'fas fa-cog',
            color: 'text-blue-600',
            label: 'Configuration Issue'
        };
    }
    
    // Vulnerability/Software findings (default)
    return {
        icon: 'fas fa-bug',
        color: 'text-red-600',
        label: 'Vulnerability'
    };
}

// Check if POAM matches active filters (delegates to column-filters.js)
function matchesFilters(poam) {
    // Search filter
    if (activeFilters.search) {
        const searchLower = activeFilters.search.toLowerCase();
        const searchableText = [
            poam.id,
            poam.vulnerability,
            poam.description,
            poam.asset,
            poam.poc
        ].join(' ').toLowerCase();
        
        if (!searchableText.includes(searchLower)) {
            return false;
        }
    }
    
    // Risk filter
    if (activeFilters.risk && poam.risk !== activeFilters.risk) {
        return false;
    }
    
    // Status filter
    if (activeFilters.status && poam.status !== activeFilters.status) {
        return false;
    }
    
    // POC filter
    if (activeFilters.poc && poam.poc !== activeFilters.poc) {
        return false;
    }
    
    // Control Family filter
    if (activeFilters.controlFamily && poam.controlFamily !== activeFilters.controlFamily) {
        return false;
    }
    
    return true;
}

// View POAM details in modal
function viewPOAMDetailsModal(poamId) {
    const poam = allVulnerabilityPOAMs.find(p => p.id === poamId);
    if (!poam) return;
    
    const modal = document.getElementById('poam-details-modal');
    const content = document.getElementById('poam-details-content');
    
    const riskColors = {
        'critical': 'red',
        'high': 'orange',
        'medium': 'yellow',
        'low': 'green'
    };
    
    content.innerHTML = `
        <div class="space-y-6">
            <div class="bg-slate-50 rounded-lg p-4">
                <h3 class="font-semibold text-slate-800 mb-3">POAM Information</h3>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div><strong>POAM ID:</strong> ${poam.id}</div>
                    <div><strong>Risk Level:</strong> <span class="px-2 py-1 bg-${riskColors[poam.risk]}-100 text-${riskColors[poam.risk]}-700 rounded text-xs font-semibold">${poam.risk.toUpperCase()}</span></div>
                    <div><strong>Status:</strong> ${poam.status.replace('_', ' ').toUpperCase()}</div>
                    <div><strong>Due Date:</strong> ${poam.dueDate}</div>
                    <div><strong>Asset:</strong> ${poam.asset}</div>
                    <div><strong>POC:</strong> ${poam.poc}</div>
                    <div><strong>Created:</strong> ${new Date(poam.createdDate).toLocaleString()}</div>
                    <div><strong>CVSS Score:</strong> ${poam.cvss}</div>
                </div>
            </div>
            
            <div class="bg-slate-50 rounded-lg p-4">
                <h3 class="font-semibold text-slate-800 mb-3">Vulnerability Details</h3>
                <p class="text-sm text-slate-700 mb-2"><strong>Title:</strong> ${poam.vulnerability}</p>
                <p class="text-sm text-slate-600">${poam.description || 'No detailed description available.'}</p>
            </div>
            
            <div class="bg-indigo-50 rounded-lg p-4">
                <h3 class="font-semibold text-slate-800 mb-3">
                    <i class="fas fa-tags mr-2 text-indigo-600"></i>Dependency Tags
                </h3>
                <p class="text-xs text-slate-600 mb-3">Tag applications or systems that depend on these assets</p>
                
                <!-- Tag Input -->
                <div class="flex gap-2 mb-3">
                    <input 
                        type="text" 
                        id="tag-input-${poam.id}"
                        placeholder="e.g., SAP, Oracle DB, Web Portal..."
                        class="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500"
                        onkeypress="if(event.key === 'Enter') addPOAMTag('${poam.id}')">
                    <button 
                        onclick="addPOAMTag('${poam.id}')"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm">
                        <i class="fas fa-plus mr-1"></i>Add Tag
                    </button>
                </div>
                
                <!-- Existing Tags -->
                <div id="tags-display-${poam.id}" class="flex flex-wrap gap-2">
                    ${poam.tags && poam.tags.length > 0 ? 
                        poam.tags.map(tag => `
                            <span class="px-3 py-1 bg-indigo-600 text-white rounded-full text-sm flex items-center gap-2">
                                <i class="fas fa-tag text-xs"></i>
                                ${tag}
                                <button 
                                    onclick="removePOAMTag('${poam.id}', '${tag}')"
                                    class="hover:text-red-300 ml-1">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </span>
                        `).join('') 
                        : '<span class="text-sm text-slate-500 italic">No tags added yet</span>'
                    }
                </div>
                
                <!-- Common Tag Suggestions -->
                <div class="mt-3 pt-3 border-t border-indigo-200">
                    <p class="text-xs text-slate-600 mb-2">Quick Add:</p>
                    <div class="flex flex-wrap gap-2">
                        ${['SAP', 'Oracle DB', 'Web Portal', 'Email System', 'File Server', 'Active Directory'].map(suggestion => `
                            <button 
                                onclick="quickAddTag('${poam.id}', '${suggestion}')"
                                class="px-2 py-1 bg-white border border-indigo-300 text-indigo-700 rounded text-xs hover:bg-indigo-100">
                                + ${suggestion}
                            </button>
                        `).join('')}
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="updatePOAMStatus('${poam.id}', 'in_progress')" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-play mr-2"></i>Mark In Progress
                </button>
                <button onclick="updatePOAMStatus('${poam.id}', 'completed')" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-check mr-2"></i>Mark Completed
                </button>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Close POAM details modal
function closePOAMDetailsModal() {
    const modal = document.getElementById('poam-details-modal');
    modal.classList.add('hidden');
}

// Add tag to POAM
async function addPOAMTag(poamId) {
    const input = document.getElementById(`tag-input-${poamId}`);
    const tagValue = input.value.trim();
    
    if (!tagValue) {
        showUpdateFeedback('Please enter a tag name', 'error');
        return;
    }
    
    try {
        // Ensure poamDB is available
        if (typeof poamDB === 'undefined' || !poamDB.db) {
            console.error('‚ùå poamDB not available');
            showUpdateFeedback('Database not available', 'error');
            return;
        }
        
        // Get POAM from IndexedDB
        const poam = await poamDB.getPOAM(poamId);
        if (!poam) {
            console.error('POAM not found:', poamId);
            return;
        }
        
        // Initialize tags array if it doesn't exist
        if (!poam.tags) {
            poam.tags = [];
        }
        
        // Check if tag already exists
        if (poam.tags.includes(tagValue)) {
            showUpdateFeedback('Tag already exists', 'error');
            return;
        }
        
        // Add tag
        poam.tags.push(tagValue);
        
        // Save to IndexedDB
        await poamDB.savePOAM(poam);
        
        // Clear input
        input.value = '';
        
        // Update display
        updateTagsDisplay(poamId, poam.tags);
        
        // Refresh table to show new tag
        await displayVulnerabilityPOAMs();
        
        showUpdateFeedback('Tag added successfully', 'success');
    } catch (error) {
        console.error('Failed to add tag:', error);
        showUpdateFeedback('Failed to add tag', 'error');
    }
}

// Remove tag from POAM
async function removePOAMTag(poamId, tagToRemove) {
    try {
        // Ensure poamDB is available
        if (typeof poamDB === 'undefined' || !poamDB.db) {
            console.error('‚ùå poamDB not available');
            showUpdateFeedback('Database not available', 'error');
            return;
        }
        
        // Get POAM from IndexedDB
        const poam = await poamDB.getPOAM(poamId);
        if (!poam) {
            console.error('POAM not found:', poamId);
            return;
        }
        
        // Remove tag
        if (poam.tags) {
            poam.tags = poam.tags.filter(tag => tag !== tagToRemove);
        }
        
        // Save to IndexedDB
        await poamDB.savePOAM(poam);
        
        // Update display
        updateTagsDisplay(poamId, poam.tags);
        
        // Refresh table to remove tag
        await displayVulnerabilityPOAMs();
        
        showUpdateFeedback('Tag removed successfully', 'success');
    } catch (error) {
        console.error('Failed to remove tag:', error);
        showUpdateFeedback('Failed to remove tag', 'error');
    }
}

// Quick add tag (from suggestions)
async function quickAddTag(poamId, tagValue) {
    const input = document.getElementById(`tag-input-${poamId}`);
    input.value = tagValue;
    await addPOAMTag(poamId);
}

// Update tags display in modal
function updateTagsDisplay(poamId, tags) {
    const display = document.getElementById(`tags-display-${poamId}`);
    if (!display) return;
    
    if (tags && tags.length > 0) {
        display.innerHTML = tags.map(tag => `
            <span class="px-3 py-1 bg-indigo-600 text-white rounded-full text-sm flex items-center gap-2">
                <i class="fas fa-tag text-xs"></i>
                ${tag}
                <button 
                    onclick="removePOAMTag('${poamId}', '${tag}')"
                    class="hover:text-red-300 ml-1">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </span>
        `).join('');
    } else {
        display.innerHTML = '<span class="text-sm text-slate-500 italic">No tags added yet</span>';
    }
}

// Update POAM status

// Export POAM report
function exportPOAMReport() {
    if (allVulnerabilityPOAMs.length === 0) {
        alert('No POAMs to export. Upload a scan first.');
        return;
    }
    
    // Create CSV content
    const headers = ['POAM ID', 'Vulnerability', 'Asset', 'Risk Level', 'Status', 'Due Date', 'POC', 'CVSS', 'Created Date'];
    const rows = allVulnerabilityPOAMs.map(poam => [
        poam.id,
        poam.vulnerability,
        poam.asset,
        poam.risk,
        poam.status,
        poam.dueDate,
        poam.poc,
        poam.cvss,
        new Date(poam.createdDate).toLocaleString()
    ]);
    
    const csvContent = [headers, ...rows].map(row => row.join(',')).join('\n');
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `POAM_Report_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    alert('‚úÖ POAM report exported successfully!');
}

// Configure API pulls (placeholder)
function configureAPIPulls() {
    alert('API Configuration feature coming soon! This will allow you to set up automated pulls from Qualys, Tenable, and other scanner APIs.');
}

// Clear old POAMs to free up storage
async function clearOldPOAMs() {
    // Ensure poamDB is available
    if (typeof poamDB === 'undefined' || !poamDB.db) {
        console.error('‚ùå poamDB not available');
        showUpdateFeedback('Database not available', 'error');
        return;
    }
    
    const poamCount = await poamDB.countPOAMs();
    
    if (confirm(`‚ö†Ô∏è Are you sure you want to delete these ${poamCount} POAMs?\n\nThis action will clear all stored POAMs and allow you to recapture a new baseline.\n\nMake sure you have exported any data you need before proceeding.\n\nContinue?`)) {
        await poamDB.clearAllPOAMs();
        totalPOAMCount = 0;
        displayVulnerabilityPOAMs();
        updateStoredPOAMCount();
        resetLastScanInfo();
        console.log('‚úÖ All POAMs have been cleared. Ready for new baseline scan.');
    }
}

// Update the stored POAM count display
async function updateStoredPOAMCount() {
    const countElement = document.getElementById('total-stored-poams');
    if (countElement) {
        // Ensure poamDB is available
        if (typeof poamDB === 'undefined' || !poamDB.db) {
            console.warn('‚ö†Ô∏è poamDB not available in updateStoredPOAMCount');
            totalPOAMCount = 0;
            countElement.textContent = totalPOAMCount;
            return;
        }
        
        totalPOAMCount = await poamDB.countPOAMs();
        countElement.textContent = totalPOAMCount;
    }
    
    // Update Clear Old Scan button state
    const clearButton = document.getElementById('clear-old-scan-btn');
    if (clearButton) {
        if (totalPOAMCount > 0) {
            clearButton.disabled = false;
            clearButton.classList.remove('opacity-50', 'cursor-not-allowed');
            clearButton.classList.add('hover:bg-red-700');
        } else {
            clearButton.disabled = true;
            clearButton.classList.add('opacity-50', 'cursor-not-allowed');
            clearButton.classList.remove('hover:bg-red-700');
        }
    }
}

// Current active metric filter
let activeMetricFilter = 'all';

// Filter POAMs by clicking metric tiles
async function filterPOAMsByMetric(metricType) {
    console.log(`üîç Filtering POAMs by: ${metricType}`);
    activeMetricFilter = metricType;
    
    // Ensure database is initialized
    if (!poamDB || !poamDB.db) {
        try {
            await poamDB.init();
        } catch (error) {
            console.error('Database not ready:', error);
            return;
        }
    }
    
    const allPoams = await poamDB.getAllPOAMs();
    const now = new Date();
    const thirtyDaysFromNow = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
    const sixtyDaysFromNow = new Date(now.getTime() + (60 * 24 * 60 * 60 * 1000));
    
    let filteredPoams;
    let filterLabel;
    
    switch (metricType) {
        case 'all':
            filteredPoams = allPoams;
            filterLabel = 'All POAMs';
            break;
        case 'critical':
            filteredPoams = allPoams.filter(p => p.risk === 'critical');
            filterLabel = 'Critical POAMs';
            break;
        case 'risk-accepted':
            filteredPoams = allPoams.filter(p => p.status === 'risk-accepted');
            filterLabel = 'Risk Accepted POAMs';
            break;
        case 'overdue':
            filteredPoams = allPoams.filter(p => {
                if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
                return new Date(p.dueDate) < now;
            });
            filterLabel = 'Overdue POAMs';
            break;
        case 'due-30':
            filteredPoams = allPoams.filter(p => {
                if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
                const dueDate = new Date(p.dueDate);
                return dueDate >= now && dueDate <= thirtyDaysFromNow;
            });
            filterLabel = 'POAMs Due in 30 Days';
            break;
        case 'due-60':
            filteredPoams = allPoams.filter(p => {
                if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
                const dueDate = new Date(p.dueDate);
                return dueDate > thirtyDaysFromNow && dueDate <= sixtyDaysFromNow;
            });
            filterLabel = 'POAMs Due in 60 Days';
            break;
        case 'closed':
            filteredPoams = allPoams.filter(p => p.status === 'completed' || p.status === 'closed');
            filterLabel = 'Closed POAMs';
            break;
        default:
            filteredPoams = allPoams;
            filterLabel = 'All POAMs';
    }
    
    // Show filter indicator
    showMetricFilterIndicator(filterLabel, filteredPoams.length);
    
    // Scroll to POAM table
    const poamSection = document.getElementById('generated-poams-section');
    if (poamSection) {
        poamSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    // Display filtered POAMs
    displayFilteredPOAMs(filteredPoams);
}

// Show filter indicator above POAM table
function showMetricFilterIndicator(label, count) {
    let indicator = document.getElementById('metric-filter-indicator');
    
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'metric-filter-indicator';
        indicator.className = 'mb-4 p-3 bg-indigo-50 border border-indigo-200 rounded-lg flex items-center justify-between';
        
        const poamSection = document.getElementById('generated-poams-section');
        if (poamSection) {
            poamSection.insertBefore(indicator, poamSection.firstChild.nextSibling);
        }
    }
    
    indicator.innerHTML = `
        <div class="flex items-center gap-2">
            <i class="fas fa-filter text-indigo-600"></i>
            <span class="font-medium text-indigo-800">Filtered: ${label}</span>
            <span class="px-2 py-1 bg-indigo-600 text-white rounded text-sm">${count} POAMs</span>
        </div>
        <button onclick="clearMetricFilter()" class="text-indigo-600 hover:text-indigo-800 text-sm font-medium">
            <i class="fas fa-times mr-1"></i>Clear Filter
        </button>
    `;
    
    indicator.classList.remove('hidden');
}

// Clear metric filter
async function clearMetricFilter() {
    activeMetricFilter = 'all';
    const indicator = document.getElementById('metric-filter-indicator');
    if (indicator) {
        indicator.classList.add('hidden');
    }
    await displayVulnerabilityPOAMs();
}

// Display filtered POAMs
async function displayFilteredPOAMs(poams) {
    const tbody = document.getElementById('vulnerability-poam-list');
    if (!tbody) return;
    
    if (poams.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="px-4 py-12 text-center text-slate-500">
                    <i class="fas fa-filter text-4xl mb-4 block text-slate-300"></i>
                    No POAMs match this filter
                </td>
            </tr>
        `;
        return;
    }
    
    // Render filtered POAMs
    tbody.innerHTML = poams.map(poam => {
        const riskColors = {
            'critical': 'bg-red-100 text-red-700',
            'high': 'bg-orange-100 text-orange-700',
            'medium': 'bg-yellow-100 text-yellow-700',
            'low': 'bg-green-100 text-green-700'
        };
        
        const statusColors = {
            'open': 'bg-blue-100 text-blue-700',
            'in-progress': 'bg-yellow-100 text-yellow-700',
            'risk-accepted': 'bg-purple-100 text-purple-700',
            'completed': 'bg-green-100 text-green-700',
            'closed': 'bg-slate-100 text-slate-700'
        };
        
        const titleDisplay = poam.title || poam.vulnerability;
        const poamIcon = getPOAMTypeIcon(poam);
        
        return `
            <tr class="border-b border-slate-100 hover:bg-indigo-50 transition-colors cursor-pointer" onclick="showPOAMDetails('${poam.id}')">
                <td class="px-4 py-3" onclick="event.stopPropagation()">
                    <input type="checkbox" class="poam-checkbox rounded border-slate-300 text-indigo-600" data-poam-id="${poam.id}" onchange="togglePOAMSelection('${poam.id}', this.checked)">
                </td>
                <td class="px-4 py-3 text-sm font-medium text-indigo-600">
                    <div class="flex items-center gap-2">
                        <i class="${poamIcon.icon} ${poamIcon.color}" title="${poamIcon.label}"></i>
                        ${poam.id}
                    </div>
                </td>
                <td class="px-4 py-3 text-sm text-slate-800">
                    <div class="max-w-md truncate" title="${titleDisplay}">${titleDisplay}</div>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${riskColors[poam.risk] || 'bg-slate-100 text-slate-700'}">${(poam.risk || 'medium').toUpperCase()}</span>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs font-semibold ${statusColors[poam.status] || 'bg-slate-100 text-slate-700'}">${(poam.status || 'open').replace('-', ' ').toUpperCase()}</span>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.poc || 'Unassigned'}</td>
                <td class="px-4 py-3 text-sm text-slate-600">${poam.dueDate || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-center font-medium text-slate-800">${poam.totalAffectedAssets || poam.assetCount || 0}</td>
            </tr>
        `;
    }).join('');
}

// Update vulnerability module metrics
async function updateVulnerabilityModuleMetrics() {
    console.log('üìä Updating vulnerability module metrics...');
    
    try {
        // Ensure database is initialized
        if (!poamDB || !poamDB.db) {
            await poamDB.init();
        }
        
        // Get all POAMs from IndexedDB
        const poams = await poamDB.getAllPOAMs();
        console.log(`üìä Found ${poams.length} POAMs for metrics calculation`);
        
        // Calculate metrics
        const totalPOAMs = poams.length;
        const criticalPOAMs = poams.filter(p => p.risk === 'critical').length;
        const riskAccepted = poams.filter(p => p.status === 'risk-accepted').length;
        
        // Calculate overdue POAMs
        const now = new Date();
        const overduePOAMs = poams.filter(p => {
            if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
            const dueDate = new Date(p.dueDate);
            return dueDate < now;
        }).length;
        
        // Calculate due in 30 days
        const thirtyDaysFromNow = new Date(now.getTime() + (30 * 24 * 60 * 60 * 1000));
        const dueIn30Days = poams.filter(p => {
            if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
            const dueDate = new Date(p.dueDate);
            return dueDate >= now && dueDate <= thirtyDaysFromNow;
        }).length;
        
        // Calculate due in 60 days
        const sixtyDaysFromNow = new Date(now.getTime() + (60 * 24 * 60 * 60 * 1000));
        const dueIn60Days = poams.filter(p => {
            if (p.status === 'completed' || p.status === 'closed' || p.status === 'risk-accepted') return false;
            const dueDate = new Date(p.dueDate);
            return dueDate > thirtyDaysFromNow && dueDate <= sixtyDaysFromNow;
        }).length;
        
        // Calculate closed POAMs
        const closedPOAMs = poams.filter(p => p.status === 'completed' || p.status === 'closed').length;
        
        // Update UI elements
        const elements = {
            'total-poams-count': totalPOAMs,
            'critical-poams-count': criticalPOAMs,
            'risk-accepted-count': riskAccepted,
            'overdue-poams-count': overduePOAMs,
            'due-30-days-count': dueIn30Days,
            'due-60-days-count': dueIn60Days,
            'poams-closed-count': closedPOAMs
        };
        
        for (const [id, value] of Object.entries(elements)) {
            const element = document.getElementById(id);
            if (element) {
                element.textContent = value;
            }
        }
        
        // Calculate Security Control Families most impacted
        updateTopControlFamilies(poams);
        
        console.log('‚úÖ Vulnerability module metrics updated successfully');
    } catch (error) {
        console.error('‚ùå Failed to update vulnerability module metrics:', error);
    }
}

// Update Security Control Families display
function updateTopControlFamilies(poams) {
    const container = document.getElementById('os-breakdown-container');
    if (!container) return;
    
    // Collect Control Family data from all POAMs
    const familyCounts = {};
    
    poams.forEach(poam => {
        const controlFamily = poam.controlFamily || poam.controlFamily || 'Unknown';
        
        if (controlFamily && controlFamily !== 'Unknown') {
            familyCounts[controlFamily] = (familyCounts[controlFamily] || 0) + 1;
        }
    });
    
    // Sort and get top 5
    const sortedFamilies = Object.entries(familyCounts)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 5);
    
    if (sortedFamilies.length === 0) {
        container.innerHTML = '<p class="text-sm text-slate-500">No control family data available</p>';
        return;
    }
    
    // Calculate max for progress bar
    const maxCount = sortedFamilies[0][1];
    
    // Render top 5 Control Families with progress bars
    container.innerHTML = sortedFamilies.map(([family, count], index) => {
        const percentage = Math.round((count / maxCount) * 100);
        const colors = ['bg-indigo-500', 'bg-blue-500', 'bg-green-500', 'bg-yellow-500', 'bg-purple-500'];
        const color = colors[index] || 'bg-slate-500';
        
        return `
            <div class="flex items-center gap-3 cursor-pointer hover:bg-slate-50 p-2 rounded" onclick="filterPOAMsByControlFamily('${family}')">
                <div class="w-8 text-center">
                    <span class="text-sm font-bold text-slate-400">#${index + 1}</span>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-medium text-slate-700">${family}</span>
                        <span class="text-slate-500">${count.toLocaleString()} POAMs</span>
                    </div>
                    <div class="w-full bg-slate-200 rounded-full h-2">
                        <div class="${color} h-2 rounded-full" style="width: ${percentage}%"></div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Normalize OS name for grouping
function normalizeOSName(osString) {
    if (!osString) return 'Unknown';
    
    // Clean up common syntax issues
    let os = osString.trim();
    
    // Remove common prefixes/suffixes and clean up syntax
    os = os.replace(/^["']|["']$/g, ''); // Remove quotes
    os = os.replace(/\s+/g, ' '); // Normalize whitespace
    os = os.replace(/[()]/g, ''); // Remove parentheses
    os = os.replace(/\b(OS|os|Os)\b/g, ''); // Remove OS suffixes
    
    const osLower = os.toLowerCase();
    
    // Windows versions
    if (osLower.includes('windows 11')) return 'Windows 11';
    if (osLower.includes('windows 10')) return 'Windows 10';
    if (osLower.includes('windows server 2022')) return 'Windows Server 2022';
    if (osLower.includes('windows server 2019')) return 'Windows Server 2019';
    if (osLower.includes('windows server 2016')) return 'Windows Server 2016';
    if (osLower.includes('windows server 2012')) return 'Windows Server 2012';
    if (osLower.includes('windows server')) return 'Windows Server';
    if (osLower.includes('windows')) return 'Windows';
    
    // Linux distributions
    if (osLower.includes('amazon linux 2023')) return 'Amazon Linux 2023';
    if (osLower.includes('amazon linux 2')) return 'Amazon Linux 2';
    if (osLower.includes('amazon linux')) return 'Amazon Linux';
    if (osLower.includes('ubuntu 22.04') || osLower.includes('ubuntu 22')) return 'Ubuntu 22.x';
    if (osLower.includes('ubuntu 20.04') || osLower.includes('ubuntu 20')) return 'Ubuntu 20.x';
    if (osLower.includes('ubuntu 18.04') || osLower.includes('ubuntu 18')) return 'Ubuntu 18.x';
    if (osLower.includes('ubuntu')) return 'Ubuntu';
    if (osLower.includes('rhel') || osLower.includes('red hat') || osLower.includes('redhat')) return 'RHEL';
    if (osLower.includes('centos')) return 'CentOS';
    if (osLower.includes('debian')) return 'Debian';
    if (osLower.includes('oracle linux')) return 'Oracle Linux';
    if (osLower.includes('suse') || osLower.includes('sles')) return 'SUSE Linux';
    if (osLower.includes('fedora')) return 'Fedora';
    if (osLower.includes('arch linux')) return 'Arch Linux';
    
    // Other systems
    if (osLower.includes('macos') || osLower.includes('mac os') || osLower.includes('darwin')) return 'macOS';
    if (osLower.includes('cisco ios') || osLower.includes('cisco')) return 'Cisco IOS';
    if (osLower.includes('vmware esxi') || osLower.includes('vmware')) return 'VMware ESXi';
    if (osLower.includes('juniper')) return 'Juniper JunOS';
    if (osLower.includes('freebsd')) return 'FreeBSD';
    if (osLower.includes('openbsd')) return 'OpenBSD';
    if (osLower.includes('netbsd')) return 'NetBSD';
    if (osLower.includes('solaris')) return 'Solaris';
    if (osLower.includes('aix')) return 'AIX';
    if (osLower.includes('hp-ux')) return 'HP-UX';
    
    // Generic Linux fallback
    if (osLower.includes('linux')) return 'Linux';
    
    // Return cleaned name if no specific match
    return os.length > 40 ? os.substring(0, 40) + '...' : os;
}

// Filter POAMs by Control Family
async function filterPOAMsByControlFamily(controlFamily) {
    console.log(`üîç Filtering POAMs by Control Family: ${controlFamily}`);
    
    if (!poamDB || !poamDB.db) {
        await poamDB.init();
    }
    
    try {
        // Apply the filter
        activeFilters.controlFamily = controlFamily;
        await displayVulnerabilityPOAMs();
        
        // Calculate filtered count
        const allPoams = await poamDB.getAllPOAMs();
        const mappedPoams = allPoams.map(poam => ({
            ...poam,
            controlFamily: poam.controlFamily || 'Unknown'
        }));
        const filteredPoams = mappedPoams.filter(poam => 
            poam.controlFamily === controlFamily
        );
        
        // Show filter indicator
        showMetricFilterIndicator(`Control Family: ${controlFamily}`, filteredPoams.length);
        
    } catch (error) {
        console.error('Failed to filter POAMs by Control Family:', error);
        showUpdateFeedback('Failed to filter POAMs', 'error');
    }
}

// Filter POAMs by OS
async function filterPOAMsByOS(osName) {
    console.log(`üîç Filtering POAMs by OS: ${osName}`);
    
    if (!poamDB || !poamDB.db) {
        await poamDB.init();
    }
    
    const allPoams = await poamDB.getAllPOAMs();
    
    // Filter POAMs that have findings with this OS
    const filteredPoams = allPoams.filter(poam => {
        const rawFindings = poam.rawFindings || [];
        return rawFindings.some(f => {
            const os = normalizeOSName(f.os || f.operatingSystem);
            return os === osName;
        });
    });
    
    showMetricFilterIndicator(`Operating System: ${osName}`, filteredPoams.length);
    
    const poamSection = document.getElementById('generated-poams-section');
    if (poamSection) {
        poamSection.scrollIntoView({ behavior: 'smooth' });
    }
    
    displayFilteredPOAMs(filteredPoams);
}

// Initialize vulnerability tracking on module load
document.addEventListener('DOMContentLoaded', async function() {
    // Wait for database to be ready
    if (typeof poamDB !== 'undefined' && poamDB.db) {
        // Load stored POAMs count
        await updateStoredPOAMCount();
        
        // Display POAMs if any exist
        await displayVulnerabilityPOAMs();
        
        // Update metrics
        await updateVulnerabilityModuleMetrics();
    } else {
        // Retry after database initializes
        setTimeout(async () => {
            // Load stored POAMs count
            await updateStoredPOAMCount();
            
            // Display POAMs if any exist
            await displayVulnerabilityPOAMs();
            
            // Update metrics
            await updateVulnerabilityModuleMetrics();
            if (document.getElementById('vulnerability-module')) {
                await displayVulnerabilityPOAMs();
                await updateStoredPOAMCount();
            }
        }, 500);
    }
});
