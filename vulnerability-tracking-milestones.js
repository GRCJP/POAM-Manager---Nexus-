// Updated vulnerability tracking with authoritative milestone pipeline
// This replaces the existing CSV processing with strict milestone-driven execution

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATED CSV PROCESSING WITH AUTHORITATIVE MILESTONE PIPELINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function processLocalCSVWithMilestones(csvContent, filename) {
    try {
        console.log('ğŸ“ processLocalCSVWithMilestones called with file:', filename);
        
        // Check if required libraries are available
        if (typeof Papa === 'undefined') {
            throw new Error('Papa Parse library not loaded');
        }
        
        if (typeof CSVFormatProcessor === 'undefined') {
            throw new Error('CSV Format Processor not loaded');
        }
        
        if (typeof AuthoritativeMilestonePipeline === 'undefined') {
            throw new Error('Authoritative Milestone Pipeline not loaded');
        }
        
        console.log('âœ… All required libraries are available');
        updateUploadProgress(10, 'Parsing CSV...', 'Reading file structure...');
        
        // Initialize format processor
        const processor = new CSVFormatProcessor();
        
        // Auto-detect format
        const detectedFormat = processor.detectFormat(csvContent);
        console.log(`ğŸ” Detected CSV format: ${detectedFormat}`);
        updateUploadProgress(20, `Processing ${detectedFormat} format...`, 'Parsing vulnerability data...');
        
        // Process CSV with format-specific processor
        const processResult = await processor.processCSV(csvContent, filename, detectedFormat);
        console.log(`ğŸ“Š Parsed ${processResult.vulnerabilities.length} vulnerabilities`);
        
        // Extract normalized vulnerabilities
        const rawVulnerabilities = processResult.vulnerabilities;
        
        if (rawVulnerabilities.length === 0) {
            throw new Error('No vulnerabilities found in CSV file');
        }
        
        updateUploadProgress(30, 'Initializing milestone pipeline...', 'Preparing for authoritative processing...');
        
        // Initialize authoritative milestone pipeline
        const pipeline = new AuthoritativeMilestonePipeline();
        
        // Prepare scan metadata
        const scanMetadata = {
            scanId: `SCAN-${new Date().toISOString().replace(/[:.]/g, '-')}`,
            filename: filename,
            format: detectedFormat,
            totalRows: processResult.totalRows || rawVulnerabilities.length,
            processedAt: new Date().toISOString()
        };
        
        // Define progress callback for milestone tracking
        const progressCallback = (progressInfo) => {
            const { overallProgress, currentMilestone, totalMilestones, milestoneProgress, milestoneName, message } = progressInfo;
            
            const overallPercent = Math.round(overallProgress * 100);
            const milestonePercent = Math.round(milestoneProgress * 100);
            
            console.log(`ğŸ“Š Progress: ${overallPercent}% | Milestone ${currentMilestone}/${totalMilestones} (${milestonePercent}%) - ${milestoneName}`);
            console.log(`   Message: ${message}`);
            
            // Update upload progress UI
            updateUploadProgress(
                overallPercent,
                `Milestone ${currentMilestone}/${totalMilestones}: ${milestoneName}`,
                `${milestonePercent}% complete - ${message}`
            );
            
            // Update milestone progress display if available
            if (window.updateMilestoneProgress) {
                window.updateMilestoneProgress(currentMilestone, milestoneProgress, milestoneName, message);
            }
        };
        
        updateUploadProgress(40, 'Starting milestone pipeline...', 'Beginning authoritative processing...');
        
        // Execute authoritative milestone pipeline
        console.log('\nğŸš€ Starting Authoritative Milestone Pipeline');
        console.log(`ğŸ“Š Total vulnerabilities: ${rawVulnerabilities.length}`);
        console.log(`ğŸ“‹ Scan ID: ${scanMetadata.scanId}`);
        
        const pipelineResult = await pipeline.runImportPipeline(rawVulnerabilities, scanMetadata, progressCallback);
        
        console.log('\nâœ… Authoritative Milestone Pipeline Completed Successfully');
        console.log(`ğŸ“‹ Final Result:`, pipelineResult);
        
        updateUploadProgress(95, 'Pipeline completed', 'Finalizing results...');
        
        // Display results
        await displayPipelineResults(pipelineResult, scanMetadata);
        
        updateUploadProgress(100, 'Complete', 'All milestones completed successfully');
        
        // Close upload modal after success
        setTimeout(() => {
            closeUploadModal();
            console.log('ğŸ“¤ Upload modal closed after successful pipeline completion');
            
            // Refresh POAM display
            if (typeof displayVulnerabilityPOAMs === 'function') {
                displayVulnerabilityPOAMs();
            }
        }, 2000);
        
        return pipelineResult;
        
    } catch (error) {
        console.error('âŒ Error in milestone pipeline processing:', error);
        
        updateUploadProgress(0, 'Error', `Pipeline failed: ${error.message}`);
        
        // Show error in upload modal
        setTimeout(() => {
            closeUploadModal();
            console.log('ğŸ“¤ Upload modal closed after error');
            console.error('âŒ Milestone pipeline processing failed. Please check the CSV format and try again.');
        }, 3000);
        
        throw error;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIPELINE RESULTS DISPLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function displayPipelineResults(pipelineResult, scanMetadata) {
    console.log('ğŸ“Š Displaying pipeline results');
    
    const { finalRunMetadata } = pipelineResult;
    const { counts } = finalRunMetadata;
    
    // Create results summary
    const resultsSummary = {
        scanId: scanMetadata.scanId,
        filename: scanMetadata.filename,
        totalFindings: counts.totalFindings,
        eligibleFindings: counts.eligibleFindings,
        excludedFindings: counts.excludedFindings,
        groupsFormed: counts.groupsFormed,
        poamsCreated: counts.poamsCreated,
        poamsSkipped: counts.poamsSkipped,
        recordsCommitted: counts.recordsCommitted,
        completedAt: finalRunMetadata.completedAt
    };
    
    // Store results for display
    window.lastPipelineResults = resultsSummary;
    
    // Display in console
    console.log('\nğŸ“Š PIPELINE RESULTS SUMMARY:');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`Scan ID: ${resultsSummary.scanId}`);
    console.log(`Filename: ${resultsSummary.filename}`);
    console.log(`Total Findings: ${resultsSummary.totalFindings}`);
    console.log(`Eligible Findings: ${resultsSummary.eligibleFindings}`);
    console.log(`Excluded Findings: ${resultsSummary.excludedFindings}`);
    console.log(`Groups Formed: ${resultsSummary.groupsFormed}`);
    console.log(`POAMs Created: ${resultsSummary.poamsCreated}`);
    console.log(`POAMs Skipped: ${resultsSummary.poamsSkipped}`);
    console.log(`Records Committed: ${resultsSummary.recordsCommitted}`);
    console.log(`Completed At: ${resultsSummary.completedAt}`);
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    // Update UI if function available
    if (typeof updateLastScanInfo === 'function') {
        updateLastScanInfo(resultsSummary);
    }
    
    // Show success notification
    if (typeof showUpdateFeedback === 'function') {
        showUpdateFeedback(
            `Successfully processed ${resultsSummary.totalFindings} findings and created ${resultsSummary.poamsCreated} POAMs`,
            'success'
        );
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILESTONE PROGRESS UI COMPONENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function createMilestoneProgressDisplay() {
    const milestoneHTML = `
        <div id="milestone-progress" class="hidden" style="margin: 20px 0;">
            <h3 style="margin-bottom: 15px; color: #1f2937;">Pipeline Milestones</h3>
            <div id="milestone-list" class="space-y-3">
                <!-- Milestones will be populated here -->
            </div>
        </div>
    `;
    
    // Insert into upload modal if it exists
    const uploadModal = document.getElementById('upload-modal');
    if (uploadModal) {
        const progressContainer = uploadModal.querySelector('.progress-container');
        if (progressContainer) {
            progressContainer.insertAdjacentHTML('afterend', milestoneHTML);
        }
    }
}

// Initialize milestone progress display
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', createMilestoneProgressDisplay);
} else {
    createMilestoneProgressDisplay();
}

window.updateMilestoneProgress = function(currentMilestone, progress, milestoneName, message) {
    const milestoneList = document.getElementById('milestone-list');
    if (!milestoneList) return;
    
    // Show milestone progress container
    const milestoneProgress = document.getElementById('milestone-progress');
    if (milestoneProgress) {
        milestoneProgress.classList.remove('hidden');
    }
    
    // Update or create milestone item
    let milestoneItem = document.getElementById(`milestone-${currentMilestone}`);
    if (!milestoneItem) {
        // Create new milestone item
        const milestoneHTML = `
            <div id="milestone-${currentMilestone}" class="milestone-item" style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #f9fafb;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-weight: 600; color: #374151;">Milestone ${currentMilestone}: ${milestoneName}</div>
                    <div id="milestone-status-${currentMilestone}" style="font-size: 12px; padding: 2px 8px; border-radius: 12px; background: #f3f4f6; color: #6b7280;">In Progress</div>
                </div>
                <div style="width: 100%; background: #e5e7eb; border-radius: 4px; height: 8px; overflow: hidden;">
                    <div id="milestone-bar-${currentMilestone}" style="height: 100%; background: #3b82f6; width: ${progress * 100}%; transition: width 0.3s ease;"></div>
                </div>
                <div id="milestone-message-${currentMilestone}" style="font-size: 11px; color: #6b7280; margin-top: 4px;">${message}</div>
            </div>
        `;
        milestoneList.insertAdjacentHTML('beforeend', milestoneHTML);
    } else {
        // Update existing milestone item
        const progressBar = document.getElementById(`milestone-bar-${currentMilestone}`);
        const statusDiv = document.getElementById(`milestone-status-${currentMilestone}`);
        const messageDiv = document.getElementById(`milestone-message-${currentMilestone}`);
        
        if (progressBar) progressBar.style.width = `${progress * 100}%`;
        if (messageDiv) messageDiv.textContent = message;
        
        if (statusDiv) {
            if (progress >= 1) {
                statusDiv.textContent = 'Completed';
                statusDiv.style.background = '#dcfce7';
                statusDiv.style.color = '#166534';
            } else {
                statusDiv.textContent = `${Math.round(progress * 100)}%`;
                statusDiv.style.background = '#f3f4f6';
                statusDiv.style.color = '#6b7280';
            }
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Replace the original processLocalCSV function with milestone-driven version
window.processLocalCSVWithMilestones = processLocalCSVWithMilestones;

// Optional: Keep original function for backward compatibility
// window.processLocalCSV = processLocalCSVWithMilestones;

console.log('âœ… vulnerability-tracking-milestones.js loaded successfully');
